# qr-code-generator: AI Coding Assistant Instructions

## Project Overview

QR code generator supporting QR versions 1-10 with SVG-first architecture. Dual package (ESM/CJS) TypeScript library with SVG, PNG, and ASCII output. Uses native Canvas API in browsers and optional `@resvg/resvg-js` in Node.js for PNG generation.

## Project Structure

- `src/` - Public API surface (index.ts, qrcode.ts, types.ts)
- `src/internal/` - Private implementation (not exported to consumers)
- `dist/` - Compiled output (browser.mjs, node.mjs, node.cjs)
- `test/` - Test suite (unit, integration, e2e, dist package tests)
- `test/helpers/` - Shared test utilities (qr-scanner.ts)
- `scripts/` - Build scripts (esbuild configurations)

## CRITICAL WORKFLOW RULES:

1. When I describe a problem, DO NOT immediately propose solutions
2. First understand the full context by reviewing documentation or asking me questions
3. Do comprehensive research of the relevant code before any diagnosis
4. Explain your confidence level (%) and reasoning before acting
5. Separate "understanding the problem" from "implementing the fix"

## Architecture & Pipeline

**Data Flow**: `Text → data-encoder → error-correction → matrix → SVG renderer → output-handler → Output`

**SVG-First Architecture**: All QR codes are rendered to SVG first. PNG output is generated by converting SVG to raster:
- **Browser**: Uses native Canvas API (`svg-to-raster-browser.ts`)
- **Node.js**: Uses `@resvg/resvg-js` (`svg-to-raster-node.ts`)

```
src/
├── index.ts              - Public API exports (2 functions, types, enums)
├── qrcode.ts             - Public function implementations (genQrImage, genQrText)
├── types.ts              - Public-only type definitions
└── internal/             - Private implementation (never exposed)
    ├── core/
    │   ├── constants.ts      - QR spec tables
    │   ├── types.ts          - Internal-only types (QRCodeConfig, etc.)
    │   └── defaults.ts       - Default values & merge functions (SINGLE SOURCE OF TRUTH)
    ├── encoding/
    │   ├── data-encoder.ts   - Mode detection, encoding, padding
    │   ├── error-correction.ts - Reed-Solomon EC, block interleaving
    │   └── formatters.ts     - QRInput type formatters (vCard, WiFi, etc.)
    ├── matrix/
    │   ├── matrix.ts           - Main orchestrator
    │   ├── matrix-core.ts      - Matrix creation, function pattern tracking
    │   ├── function-patterns.ts - Finder, alignment, timing pattern placement
    │   ├── data-placement.ts   - Zigzag data bit placement algorithm
    │   ├── mask-selection.ts   - 8 mask patterns, penalty calculation
    │   └── format-info.ts      - Format and version information encoding
    └── rendering/
        ├── svg-renderer.ts          - SVG string generation (PRIMARY RENDERER)
        ├── ascii-renderer.ts        - ASCII text output
        ├── output-handler.ts        - Routes output (SVG/PNG, string/dataURL/buffer)
        ├── svg-to-raster-browser.ts - Browser PNG converter (Canvas API)
        ├── svg-to-raster-node.ts    - Node.js PNG converter (resvg)
        ├── shapes.ts                - Shape implementations (eyes, pupils, dots, borders)
        └── utils.ts                 - Shared utilities
```

## File & Folder Reference

| Path | Purpose |
|------|---------|
| **Root Configuration** |
| `package.json` | Package metadata, scripts, conditional exports |
| `tsconfig.json` | TypeScript compiler configuration |
| `vitest.config.ts` | Test runner configuration with alias resolution |
| **Build Scripts** |
| `scripts/build-browser.mjs` | esbuild config for browser bundle (no resvg) |
| `scripts/build-node-esm.mjs` | esbuild config for Node.js ESM bundle |
| `scripts/build-node-cjs.mjs` | esbuild config for Node.js CJS bundle |
| **Public API (`src/`)** |
| `src/index.ts` | Public API entry point - exports `genQrImage`, `genQrText`, types, enums |
| `src/qrcode.ts` | Public function implementations + internal helper `buildQRCodeConfig` |
| `src/types.ts` | Public-only type definitions (ImageOptions, TextOptions, OutputConfig, etc.) |
| `src/svg-to-raster-converter.d.ts` | TypeScript declaration for aliased module |
| **Internal Rendering Module** |
| `src/internal/rendering/svg-renderer.ts` | SVG generation (primary renderer) |
| `src/internal/rendering/output-handler.ts` | Output routing based on format/type |
| `src/internal/rendering/svg-to-raster-browser.ts` | Browser: SVG→PNG via Canvas |
| `src/internal/rendering/svg-to-raster-node.ts` | Node: SVG→PNG via resvg |
| **Build Output (`dist/`)** |
| `dist/browser.mjs` | Browser ESM bundle (Canvas-based PNG) |
| `dist/node.mjs` | Node.js ESM bundle (resvg-based PNG) |
| `dist/node.cjs` | Node.js CJS bundle (resvg-based PNG) |
| `dist/index.d.ts` | TypeScript declarations |
| **Test Suite** |
| `test/helpers/qr-scanner.ts` | Shared dual-scanner utility (jsQR + @nuintun/qrcode) |
| `test/dist/` | Distribution package tests (validates built bundles) |

## Critical Conventions

### Public vs Private API Boundary

**Public API** (`src/` root level):
- `genQrImage(input, options?)` - Async, returns PNG buffer by default
- `genQrText(input, options?)` - Sync, returns ASCII string

**Private implementation** (`src/internal/`):
- Everything in `internal/` folder is implementation detail
- `buildQRCodeConfig()` exported from `qrcode.ts` for test access only

### Build System

```bash
npm run build  # Full build: types → browser → node-esm → node-cjs
```

**Build outputs**:
- `dist/browser.mjs` - Browser bundle (Canvas-based PNG, no resvg)
- `dist/node.mjs` - Node.js ESM bundle (resvg-based PNG)
- `dist/node.cjs` - Node.js CJS bundle (resvg-based PNG)
- `dist/index.d.ts` - TypeScript declarations

**Module alias pattern**: The `svg-to-raster-converter` import in `output-handler.ts` is resolved at build time:
- Browser build → `svg-to-raster-browser.ts`
- Node builds → `svg-to-raster-node.ts`
- Vitest → configured in `vitest.config.ts` alias

### Single Authority Merge Pattern

Options are merged **exactly once** at the entry point:

```typescript
export async function genQrImage(input: QRInput, options?: ImageOptions) {
  const mergedOptions = mergeImageOptions(options); // ← Single merge
  // ... rest uses mergedOptions
}
```

### Output Configuration

The `output` option controls format and type:

```typescript
interface OutputConfig {
  format: 'png' | 'svg';
  type: 'buffer' | 'dataURL' | 'string';  // string only for SVG
}

// Default: { format: 'png', type: 'buffer' }
```

## Development Workflows

### Testing

```bash
npm test                  # Source code tests (254 tests)
npm run test:unit         # Unit tests only
npm run test:integration  # Integration tests
npm run test:e2e          # E2E scannability tests
npm run test:dist         # Built package tests (26 tests, requires build)
```

**Test environments:**
- Source tests: Run against `src/` via vitest (uses Node.js svg-to-raster alias)
- Dist tests: Run against `dist/` bundles in actual target environments
  - Node tests: Import from `dist/node.mjs` and `dist/node.cjs`
  - Browser tests: Load `dist/browser.mjs` in Chromium via Playwright

**Scannability validation**: Both source and dist tests validate QR codes with dual scanners (jsQR + @nuintun/qrcode).

### Adding New Features

1. Add types to `src/types.ts` (public) or `src/internal/core/types.ts` (internal)
2. Add defaults to `src/internal/core/defaults.ts`
3. Update merge functions if needed
4. Implement in appropriate renderer
5. Add tests

## Common Pitfalls

1. **Module alias**: The `svg-to-raster-converter` module is aliased at build time. Tests use the vitest alias config.

2. **Async API**: `genQrImage()` is async because PNG generation may be async (Canvas/resvg).

3. **Browser vs Node**: Browser bundle uses Canvas API (no dependencies), Node bundle uses optional `@resvg/resvg-js`.

4. **Output types**: PNG supports `buffer` and `dataURL`. SVG supports `string` and `dataURL`.

## Public API Surface

```typescript
// Main functions
genQrImage(input, options?)   // Returns Promise<string | Buffer | Uint8Array>
genQrText(input, options?)    // Returns string

// Types
ImageOptions, TextOptions, OutputConfig, QRInput, VCardData, WiFiData, etc.

// Enums
EyeFrameShape, DotShape, BorderShape, BorderStyle
```
